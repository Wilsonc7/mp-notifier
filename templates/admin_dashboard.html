{% extends "_base.html" %}
{% block title %}Admin · Dashboard{% endblock %}

{% block content %}
<h2>Dashboard Global</h2>

<div class="cards">
  <div class="card">
    <h3>Hoy</h3>
    <p><b>${{ metrics.today.total }}</b> — {{ metrics.today.count }} pagos</p>
  </div>
  <div class="card">
    <h3>Semana</h3>
    <p><b>${{ metrics.week.total }}</b> — {{ metrics.week.count }} pagos</p>
  </div>
  <div class="card">
    <h3>Mes</h3>
    <p><b>${{ metrics.month.total }}</b> — {{ metrics.month.count }} pagos</p>
  </div>
</div>

<canvas id="chartGlobal" height="110"></canvas>

<h3 style="margin-top:24px">Top negocios (por mes)</h3>
<table class="table">
  <thead><tr><th>ID</th><th>Nombre</th><th>Estado</th><th>Hoy</th><th>Semana</th><th>Mes</th><th></th></tr></thead>
  <tbody>
    {% for b in board %}
    <tr>
      <td>{{ b.id }}</td>
      <td>{{ b.name }}</td>
      <td>
        {% if b.active %}<span class="badge green">activo</span>
        {% else %}<span class="badge red">bloqueado</span>{% endif %}
      </td>
      <td>${{ b.today_total }}</td>
      <td>${{ b.week_total }}</td>
      <td><b>${{ b.month_total }}</b></td>
      <td>
        <a class="btn" href="{{ url_for('admin_business_view', biz_id=b.id) }}">Ver</a>
        <a class="btn" href="{{ url_for('admin_impersonate', biz_id=b.id) }}">Ver como</a>
        <button class="btn-ghost" onclick="toggle('{{ b.id }}', this)">{{ 'Desactivar' if b.active else 'Activar' }}</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const series = {{ metrics.series|tojson }};
new Chart(document.getElementById('chartGlobal'), {
  type: 'line',
  data: {
    labels: series.map(x=>x.date),
    datasets: [{
      label: 'Total ($)',
      data: series.map(x=>x.total)
    },{
      label: 'Pagos',
      data: series.map(x=>x.count),
      yAxisID: 'y1'
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: { beginAtZero:true },
      y1: { position: 'right', beginAtZero:true, grid:{ drawOnChartArea:false } }
    }
  }
});
async function toggle(id, btn){
  const r = await fetch(`/admin/toggle/${id}`, {method:'POST'});
  const j = await r.json();
  if(j.ok){ location.reload(); }
}
</script>
{% endblock %}
